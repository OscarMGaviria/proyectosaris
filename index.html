<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APUs Estructurados - Gobernaci贸n de Antioquia</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --verde-antioquia: #1B5E20;
            --verde-oscuro: #0D3311;
            --verde-claro: #2E7D32;
            --gris-claro: #6c757d;
            --dorado: #D4AF37;
            --dorado-claro: #F5E6A3;
            --dorado-suave: rgba(212, 175, 55, 0.15);
            --negro: #1a1a1a;
            --gris-oscuro: #2d2d2d;
            --gris-medio: #5a5a5a;
            --gris-claro: #f5f5f5;
            --blanco: #ffffff;
            --sombra: 0 4px 24px rgba(0,0,0,0.12);
            --sombra-elevada: 0 12px 48px rgba(0,0,0,0.2);
            --radio: 12px;
            --transicion: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 100%);
            color: var(--negro);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-antioquia) 50%, var(--verde-claro) 100%);
            padding: 1rem 2rem;
            box-shadow: var(--sombra-elevada);
            flex-shrink: 0;
        }

        .header-content {
            max-width: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--dorado);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--verde-oscuro);
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .logo-text h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--blanco);
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            font-size: 0.7rem;
            color: var(--dorado-claro);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logo{

            width: 120px;
        }

        .header-stats {
            display: flex;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radio);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 80px;
        }

        .stat-item .number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dorado);
            line-height: 1;
        }

        .stat-item .label {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.2rem;
        }

        /* Main Container */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
        }

        footer {
            margin-top: auto;
        }


        /* Controls Panel */
        .controls-panel {
            background: var(--blanco);
            border-radius: var(--radio);
            box-shadow: var(--sombra);
            padding: 1rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .controls-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 2px solid var(--gris-claro);
            border-radius: var(--radio);
            font-size: 0.95rem;
            transition: var(--transicion);
            background: var(--blanco);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--verde-claro);
            box-shadow: 0 0 0 3px var(--dorado-suave);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gris-medio);
            width: 18px;
            height: 18px;
        }

        .filter-container {
            flex-shrink: 0;
        }

        .filter-select {
            padding: 0.75rem;
            border: 2px solid var(--gris-claro);
            border-radius: var(--radio);
            background: var(--blanco);
            min-width: 200px;
            font-size: 0.95rem;
            transition: var(--transicion);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--verde-claro);
            box-shadow: 0 0 0 3px var(--dorado-suave);
        }

        /* Table Container */
        .table-container {
            flex: 1;
            background: var(--blanco);
            border-radius: var(--radio);
            box-shadow: var(--sombra);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .table-header {
            background: var(--verde-antioquia);
            color: var(--blanco);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .table-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        #apus-section {
            height: 100%;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }


        
        .table-wrapper {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--verde-claro);
            color: var(--blanco);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--gris-claro);
            font-size: 0.9rem;
        }

        tbody tr {
            cursor: pointer;
            transition: var(--transicion);
        }

        tbody tr:hover {
            background: linear-gradient(90deg, var(--dorado-suave), transparent);
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:nth-child(even):hover {
            background: linear-gradient(90deg, var(--dorado-suave), rgba(212, 175, 55, 0.08));
        }

        .item-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--verde-oscuro);
            background: var(--dorado-claro);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .unit-badge {
            background: var(--verde-claro);
            color: var(--blanco);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .price {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--verde-oscuro);
            text-align: right;
        }

        .description {
            color: var(--gris-oscuro);
            line-height: 1.4;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transicion);
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: white;
            border-radius: 16px;
            box-shadow: var(--sombra-elevada);
            max-width: 95vw;
            width: 1200px;
            height: 85vh; /* ALTURA FIJA */
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* IMPORTANTE */
            margin: auto;
            position: relative;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--verde-oscuro), var(--verde-antioquia));
            color: var(--blanco);
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .modal-title {
            flex: 1;
        }

        .modal-title h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .modal-title p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--blanco);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transicion);
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 2rem;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            color: var(--verde-oscuro);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--dorado-claro);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            background: var(--gris-claro);
            padding: 1rem;
            border-radius: var(--radio);
            text-align: center;
        }

        .detail-item .label {
            font-size: 0.8rem;
            color: var(--gris-medio);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .detail-item .value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--verde-oscuro);
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .detail-table th {
            background: var(--verde-claro);
            color: var(--blanco);
            padding: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .detail-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gris-claro);
            font-size: 0.9rem;
        }

        .detail-table .numeric {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .no-data {
            text-align: center;
            color: var(--gris-medio);
            font-style: italic;
            padding: 3rem;
        }

        /* Loading indicator */
        .loading-indicator {
            text-align: center;
            padding: 3rem;
            color: var(--gris-medio);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--gris-claro);
            border-top: 3px solid var(--verde-claro);
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-stats {
                gap: 0.5rem;
            }

            .stat-item {
                padding: 0.4rem 0.8rem;
                min-width: 70px;
            }

            .controls-row {
                flex-direction: column;
                gap: 0.75rem;
            }

            .search-container {
                min-width: unset;
            }

            .filter-select {
                min-width: unset;
                width: 100%;
            }

            .modal {
                width: 95vw;
                margin: 1rem;
            }

            .modal-header {
                padding: 1.5rem;
                flex-direction: column;
                gap: 1rem;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .table-header {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 0.5rem;
            }

            header {
                padding: 0.75rem 1rem;
            }

            .logo-text h1 {
                font-size: 1.1rem;
            }

            th, td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
        }




        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radio);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transicion);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--verde-antioquia), var(--verde-claro));
            color: var(--blanco);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--sombra);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }




/* ===============================
   CONTENEDOR GENERAL CENTRADO
================================ */
.presentacion-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    box-sizing: border-box;
}

/* ===============================
   TARJETA / CARD
================================ */
.presentacion-card {
    width: 80%;
    height: 100%;
    background: #ffffff;
    padding: 30px 40px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    border: 1px solid #e5e5e5;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ===============================
   CONTENIDO SCROLL
================================ */
.presentacion-content {
    max-height: 600px;
    overflow-y: auto;
    padding-right: 12px;
    text-align: justify;
    font-size: 15px;
    line-height: 1.6;
    color: #333;
}

/* Scroll personalizado */
.presentacion-content::-webkit-scrollbar {
    width: 8px;
}

.presentacion-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 8px;
}

.presentacion-content::-webkit-scrollbar-thumb {
    background: #8d8d8d;
    border-radius: 8px;
}

.presentacion-content::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* ===============================
   TITULOS
================================ */
.presentacion-title {
    font-size: 18px;

    font-weight: bold;
    margin-bottom: 15px;
    color: #1e3d1e; /* Verde suave institucional */
}

.presentacion-subtitle {
    font-size: 18px;
    font-weight: 600;
    margin-top: 20px;
    margin-bottom: 10px;
    color: #1e3d1e;
}

/* ===============================
   PARRAFOS
================================ */
.presentacion-parrafo {
    font-size: 18px;
    margin-top: 12px;
    margin-bottom: 12px;
}

/* ===============================
   LISTAS
================================ */
.presentacion-lista {
    margin-left: 25px;
    font-size: 18px;
    margin-top: 10px;
    margin-bottom: 15px;
}

.presentacion-lista li {
    margin-bottom: 10px;
}

/* ===============================
   RESPONSIVE
================================ */
@media screen and (max-width: 1100px) {
    .presentacion-card {
        width: 80%;
    }
}

@media screen and (max-width: 768px) {
    .presentacion-card {
        width: 92%;
        padding: 20px;
    }
}

.logo-press {
    width: 250px;
}
.presentacion-header{
    display: block;
    justify-content: center;
    align-items: center;
   text-align: center; 
}




















/* Navigation Styles */
        .header-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--radio);
            transition: var(--transicion);
            font-weight: 500;
            font-size: 0.9rem;
            border: 1px solid transparent;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--dorado-claro);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .nav-link.active {
            background: var(--dorado);
            color: var(--verde-oscuro);
            font-weight: 600;
            border-color: var(--dorado);
        }

        /* Content Sections */
        .content-section {
            display: none !important;
        }

        .content-section.active {
            display: block !important;
        }

        #apus-section.active {
            display: flex !important;
            flex-direction: column;
        }

        .presentacion-content, .marco-metodologico-content {
            background: var(--blanco);
            border-radius: var(--radio);
            box-shadow: var(--sombra);
            padding: 2rem;
            margin: 1rem 0;
            line-height: 1.6;
        }

        .presentacion-content h2, .marco-metodologico-content h2 {
            color: var(--verde-oscuro);
            font-family: 'Playfair Display', serif;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .presentacion-content h3, .marco-metodologico-content h3 {
            color: var(--verde-claro);
            margin: 1.5rem 0 0.8rem 0;
            font-size: 1.3rem;
        }



    /* Estilos para pesta帽as del modal consolidado */
    .consolidatedTab {
        color: var(--gris-medio) !important;
        border: none !important;
        border-bottom: 3px solid transparent !important;
        background: none !important;
        font-weight: 500;
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .consolidatedTab:hover {
        border-bottom-color: var(--dorado) !important;
        color: var(--verde-antioquia) !important;
        background: var(--dorado-suave) !important;
    }

    .consolidatedTab.active {
        color: var(--verde-antioquia) !important;
        border-bottom-color: var(--verde-antioquia) !important;
        background: var(--dorado-suave) !important;
        font-weight: 600;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.show {
        display: block;
    }

    .tab-badge {
        background: var(--verde-antioquia);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 50px;
        margin-left: 0.5rem;
        font-weight: bold;
    }

    .section-title-tab {
        color: var(--verde-antioquia);
        font-weight: 600;
        font-size: 1.1rem;
        border-bottom: 2px solid var(--dorado);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }




/* Estilos mejorados para pesta帽as horizontales del modal consolidado */
#consolidatedTabs {
    display: flex;
    justify-content: space-between;
    background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-antioquia) 100%);
    border-radius: 12px 12px 0 0;
    padding: 0.5rem;
    margin: 0;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#consolidatedTabs .nav-item {
    flex: 1;
    margin: 0 0.25rem;
}

.consolidatedTab {
    width: 100% !important;
    color: rgba(255,255,255,0.8) !important;
    border: none !important;
    background: rgba(255,255,255,0.1) !important;
    font-weight: 500;
    font-size: 0.85rem;
    padding: 0.75rem 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    border-radius: 8px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.consolidatedTab::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.consolidatedTab:hover::before {
    opacity: 1;
}

.consolidatedTab:hover {
    color: white !important;
    background: rgba(255,255,255,0.2) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.consolidatedTab.active {
    color: var(--verde-oscuro) !important;
    background: var(--dorado) !important;
    font-weight: 600;
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(212, 175, 55, 0.4);
}

.consolidatedTab.active::before {
    opacity: 0;
}

.tab-content {
    flex: 1; /* OCUPA TODO EL ESPACIO RESTANTE */
    margin: 0 1rem 1rem 1rem;
    border: 2px solid var(--verde-antioquia);
    border-top: none;
    border-radius: 0 0 12px 12px;
    background: white;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    overflow: hidden; /* IMPORTANTE */
}

.tab-pane {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.tab-pane.show {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tab-badge {
    background: var(--verde-oscuro);
    color: var(--dorado);
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 50px;
    margin-top: 0.25rem;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
    border: 1px solid var(--dorado);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.consolidatedTab.active .tab-badge {
    background: var(--verde-oscuro);
    color: var(--dorado);
    border-color: var(--verde-oscuro);
}

.section-title-tab {
    color: var(--verde-antioquia);
    font-weight: 600;
    font-size: 1.1rem;
    border-bottom: 3px solid var(--dorado);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Iconos de pesta帽as m谩s grandes */
.consolidatedTab .tab-icon {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
    display: block;
}

.consolidatedTab .tab-text {
    font-size: 0.75rem;
    line-height: 1.2;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.3px;
}

/* Responsive para pantallas peque帽as */
@media (max-width: 768px) {
    #consolidatedTabs {
        flex-wrap: wrap;
    }
    
    #consolidatedTabs .nav-item {
        flex: 0 0 48%;
        margin-bottom: 0.5rem;
    }
    
    .consolidatedTab {
        min-height: 50px;
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
    }
    
    .consolidatedTab .tab-icon {
        font-size: 1rem;
    }
    
    .consolidatedTab .tab-text {
        font-size: 0.65rem;
    }
}

/* Efectos adicionales para mejorar la experiencia */
.modal-overlay.active {
    backdrop-filter: blur(5px);
}

.modal-overlay.active .modal {
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}





    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <img class="logo" src="LogoGA.png" alt="">
                <div class="logo-text">
                    <h1>VIPRA</h1>
                    <span>Departamento de Antioquia</span>
                </div>
            </div>
            <div class="header-stats">
                <nav class="header-nav">
                    <a href="#presentacion" class="nav-link active" onclick="showPresentacion()">Presentaci贸n</a>
                    <a href="#marco-metodologico" class="nav-link" onclick="showMarcoMetodologico()">Marco Metodol贸gico</a>
                    <a href="#apus" class="nav-link" onclick="showAPUs()">APUs</a>
                </nav>
                <div class="stat-item">
                    <div class="number" id="totalApus">0</div>
                    <div class="label">Total APUs</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="filteredCount">0</div>
                    <div class="label">Mostrados</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="subregionCount">0</div>
                    <div class="label">Subregiones</div>
                </div>
            </div>
        </div>
    </header>


    <!-- Main Content -->
    <div class="main-container">
        <!-- SECCIN PRESENTACIN -->
        <div id="presentacion-section" class="content-section active">
            <div class="presentacion-container">
                <div class="presentacion-card">
                    <div class="presentacion-header">
                        <img src="LogoGGA.png" alt="Logo" class="logo-press">
                        <h2>Presentaci贸n</h2>
                    </div>
                    <div class="presentacion-content">
                        <br>
                        <h4 class="presentacion-title">
                            1. Visor Interactivo de APUS para la Secretar铆a de Infraestructura F铆sica del Departamento de Antioquia
                        </h4>

                        <p class="presentacion-parrafo">
                            La Direcci贸n de Estructuraci贸n de Proyectos, en cumplimiento de las funciones asignadas por la Secretar铆a de Infraestructura F铆sica del Departamento de Antioquia, tiene entre sus responsabilidades la administraci贸n, actualizaci贸n y mantenimiento de los sistemas de informaci贸n que apoyan la planeaci贸n, estructuraci贸n y ejecuci贸n de proyectos de infraestructura en el departamento, abarcando el sistema de infraestructura vial.
                        </p>

                        <p class="presentacion-parrafo">
                            En este marco, la publicaci贸n del presente Visor de Precios Unitarios de Referencia tiene como finalidad socializar los resultados del proceso de actualizaci贸n de la Base de Precios Unitarios de Referencia de la Secretar铆a de Infraestructura F铆sica.
                        </p>

                        <p class="presentacion-parrafo">
                            El objetivo de este visor es proporcionar a los usuarios internos y externos una herramienta t茅cnica, confiable y actualizada, que sirva como referencia para la planeaci贸n, formulaci贸n y evaluaci贸n de los presupuestos de infraestructura ejecutados en el territorio antioque帽o.
                        </p>

                        <h4 class="presentacion-title">2. Aclaraciones sobre el uso de la informaci贸n</h4>

                        <p class="presentacion-parrafo">
                            Por 煤ltimo, se resalta que esta publicaci贸n constituye una herramienta de consulta y referencia que puede ser empleada para la planeaci贸n y elaboraci贸n de presupuestos de obras de infraestructura en sus diferentes tipolog铆as, de acuerdo con las necesidades y particularidades de cada proyecto.
                        </p>

                        <p class="presentacion-parrafo">
                            Con el fin de dar alcance a la responsabilidad de la Entidad frente a la informaci贸n que suministra al p煤blico en general, se aclara que esta no reemplaza el an谩lisis t茅cnico ni los soportes espec铆ficos requeridos en cada proceso, los cuales deber谩n adelantarse considerando las condiciones particulares de cada caso.
                        </p>

                        <p class="presentacion-parrafo">
                            Por tanto, el uso de los datos publicados compromete 煤nicamente la responsabilidad del interesado, quien debe verificar y/o actualizar la informaci贸n conforme a sus necesidades.
                        </p>

                        <p class="presentacion-parrafo">
                            A continuaci贸n, se presentan las principales precisiones:
                        </p>

                        <ol class="presentacion-lista">
                            <li>La Secretar铆a de Infraestructura F铆sica no garantiza que los precios publicados se ajusten a ninguna situaci贸n t茅cnica o proyecto particular.</li>
                            <li>El uso de los datos publicados es responsabilidad exclusiva del interesado, quien deber谩 verificar y/o actualizar la informaci贸n seg煤n su aplicaci贸n espec铆fica.</li>
                            <li>Los datos contenidos en la Base de Precios de Referencia no sustituyen la labor de los consultores internos o externos, quienes tienen la obligaci贸n contractual de analizar, evaluar y sustentar cada caso de manera individual.</li>
                            <li>Los precios de referencia publicados no son indicativos de valores de contrataci贸n. Cada proceso licitatorio o contractual se adelanta de acuerdo con sus propias condiciones y estudios previos.</li>
                            <li>El registro de marcas o productos comerciales no implica recomendaci贸n o preferencia alguna por parte de la Entidad. La responsabilidad de su selecci贸n recae exclusivamente sobre los consultores o responsables del proyecto con base en la especificaci贸n tecnica requerida.</li>
                            <li>Los precios de insumos no contemplan descuentos por volumen de compra ni condiciones comerciales particulares. Como regla general, incluyen el valor del IVA; el interesado debe confirmar esta condici贸n directamente con su proveedor.</li>
                        </ol>

                        <p class="presentacion-parrafo">
                            Con esta herramienta, el Departamento de Antioquia, a trav茅s de la Secretar铆a de Infraestructura F铆sica, reafirma su compromiso con la transparencia, la eficiencia y la modernizaci贸n en la gesti贸n p煤blica, contribuyendo al fortalecimiento de los procesos de planeaci贸n y ejecuci贸n de la infraestructura del departamento.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIN MARCO METODOLGICO -->
        <div id="marco-metodologico-section" class="content-section">
            <div class="presentacion-container">
                <div class="presentacion-card">
                    <div class="presentacion-header">
                        <img src="LogoGGA.png" alt="Logo" class="logo-press">
                        <h2>Marco metodol贸gico</h2>
                    </div>
                    <div class="presentacion-content">
                        <h4 class="presentacion-title">1. Proceso de Recolecci贸n, An谩lisis, Depuraci贸n y Publicaci贸n de Precios</h4>

                        <p class="presentacion-parrafo">
                            La metodolog铆a empleada por la Secretar铆a de Infraestructura F铆sica del Departamento de Antioquia
                            comprende el estudio del comportamiento de los precios de los insumos empleados en las diferentes
                            obras de infraestructura departamental.
                        </p>

                        <p class="presentacion-parrafo">
                            El objetivo principal es identificar precios de referencia confiables y actualizados que sirvan de apoyo
                            en la planeaci贸n, formulaci贸n, ejecuci贸n y seguimiento de los proyectos de inversi贸n que lidera o
                            acompa帽a la Secretar铆a.
                        </p>

                        <p class="presentacion-parrafo">
                            La informaci贸n es recolectada por el equipo de Presupuestos de la Direcci贸n de Estructuraci贸n de 
                            Proyectos, mediante un trabajo directo que consiste en la captura de informaci贸n a trav茅s de estudios 
                            de mercado de una canasta representativa de insumos, previamente definida con base en los contratos y 
                            proyectos m谩s relevantes del Departamento.
                        </p>

                        <p class="presentacion-parrafo">
                            Una vez culminado el proceso de validaci贸n y verificaci贸n, la informaci贸n consolidada se pone a 
                            disposici贸n de los usuarios internos y externos a trav茅s del Visor de Precios Unitarios de Referencia, 
                            garantizando el acceso a una base de datos confiable que apoya las labores de planeaci贸n, 
                            estructuraci贸n, contrataci贸n y seguimiento de la infraestructura del Departamento de Antioquia.
                        </p>

                        <p class="presentacion-parrafo">
                            El an谩lisis de la informaci贸n se realiza conforme a lineamientos metodol贸gicos preestablecidos, que 
                            incluyen la revisi贸n de variables como registros hist贸ricos, precios, especificaciones t茅cnicas, 
                            cotizaciones, observaciones, controles de validaci贸n y proveedores.
                        </p>

                        <p class="presentacion-parrafo">
                            Cada insumo es analizado individualmente para verificar los cambios en sus precios; posteriormente, se 
                            realiza un an谩lisis comparativo por proveedor con el fin de corroborar el cumplimiento de los criterios 
                            definidos para el comportamiento de los insumos. Aquellos que presentan desviaciones significativas son 
                            objeto de una verificaci贸n adicional antes de su validaci贸n y aprobaci贸n final.
                        </p>

                        <p class="presentacion-parrafo">
                            Para efectos del procesamiento y c谩lculo, a cada insumo se le asigna un c贸digo 煤nico correspondiente al 
                            sistema de codificaci贸n oficial de la Secretar铆a, asociado a su cap铆tulo y an谩lisis de costos unitarios, 
                            garantizando uniformidad en el manejo de la informaci贸n.
                        </p>

                        <h4 class="presentacion-title">2. Dise帽o Estad铆stico</h4>

                        <h6 class="presentacion-subtitle">2.1 Poblaci贸n Objetivo</h6>
                        <p class="presentacion-parrafo">
                            Hace parte de la poblaci贸n objetivo toda persona interna o externa de la entidad dedicada a la consulta 
                            de materiales, alquiler de maquinaria y suministro de mano de obra, que participe directa o 
                            indirectamente en los proyectos de infraestructura desarrollados por el Departamento de Antioquia.
                        </p>

                        <h6 class="presentacion-subtitle">2.2 Marco Estad铆stico</h6>
                        <p class="presentacion-parrafo">
                            Los criterios de selecci贸n de las fuentes para la toma de precios se basan en los siguientes aspectos:
                        </p>

                        <ol class="presentacion-lista">
                            <li>Que la fuente sea especializada en la producci贸n o comercializaci贸n de materiales de construcci贸n.</li>
                            <li>Que los art铆culos informados tengan venta o producci贸n continua y representativa.</li>
                            <li>Que las fuentes de alquiler de maquinaria sean proveedores activos del sector constructor.</li>
                            <li>Que los establecimientos seleccionados puedan ser productores, distribuidores mayoristas o minoristas.</li>
                            <li>Que la informaci贸n suministrada sea veraz, verificable y representativa del mercado.</li>
                        </ol>

                        <h6 class="presentacion-subtitle">2.3 Definici贸n de Variables</h6>
                        <p class="presentacion-parrafo">
                            La variable fundamental para la base de precios es el precio de los insumos que conforman la canasta 
                            de referencia, a los cuales se les realiza seguimiento de manera peri贸dica y sistem谩tica.
                        </p>

                        <h4 class="presentacion-title">3. Unidades Estad铆sticas</h4>
                        <h6 class="presentacion-subtitle">3.1 Unidad de Observaci贸n</h6>
                        <p class="presentacion-parrafo">Insumos y/o variedades de insumos incluidos en la canasta representativa de la infraestructura departamental.</p>
                        <h6 class="presentacion-subtitle">3.2 Unidad de An谩lisis</h6>
                        
                        <p class="presentacion-parrafo">Precios de los insumos m谩s relevantes empleados en las obras de infraestructura del departamento.</p>

                        <h4 class="presentacion-title">4. Periodo de Referencia</h4>
                        <p class="presentacion-parrafo">
                            Corresponde al periodo en que se actualizan los precios de la canasta definida, los cuales se registran 
                            a precios nominales del mes de recolecci贸n.
                        </p>

                        <h4 class="presentacion-title">5. Dise帽o de la Ejecuci贸n</h4>
                        <p class="presentacion-parrafo">
                            El proceso de recolecci贸n, procesamiento y validaci贸n comprende las fases de:
                        </p>

                        <ol class="presentacion-lista">
                            <li>Definici贸n de la canasta de insumos.</li>
                            <li>Estudio de mercado.</li>
                            <li>Depuraci贸n y verificaci贸n de la informaci贸n.</li>
                            <li>An谩lisis y validaci贸n de precios.</li>
                            <li>Carga y publicaci贸n en el Visor de Precios Unitarios de Referencia.</li>
                        </ol>

                        <h4 class="presentacion-title">6. Dise帽o del An谩lisis de Resultados</h4>
                        <h4 class="presentacion-subtitle">6.1 An谩lisis de Contexto e Impacto</h4>
                        <p class="presentacion-parrafo">
                            Se realizan ejercicios de seguimiento a las tendencias del mercado, comparaciones con otras fuentes 
                            de informaci贸n y validaciones de consistencia t茅cnica para garantizar la comparabilidad de los datos.
                        </p>

                        <h4 class="presentacion-title">7. Dise帽o de la Difusi贸n y Publicaci贸n</h4>

                        <p class="presentacion-parrafo">Los productos generados incluyen:</p>

                        <ul class="presentacion-lista">
                            <li>Memoria t茅cnica del proceso de recolecci贸n, depuraci贸n, an谩lisis y divulgaci贸n.</li>
                            <li>Base de datos actualizada, disponible en el repositorio oficial del 谩rea de Presupuestos.</li>
                            <li>Documentaci贸n de an谩lisis de informaci贸n con simulaciones de variaci贸n de precios.</li>
                            <li>Visor interactivo de consulta para usuarios internos y externos.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIN APUs -->
        <div id="apus-section" class="content-section">
            <!-- Controls -->
            <div class="controls-panel">
                <div class="controls-row">
                    <div class="search-container">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" class="search-input" id="searchInput" placeholder="Buscar por c贸digo o descripci贸n...">
                    </div>
                    <div class="filter-container">
                        <select id="subregionFilter" class="filter-select">
                            <option value="">Todas las subregiones</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">APUs Disponibles</div>

                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="table-info">Total: <span id="tableCount">0</span> elementos</div>
                        <button class="btn btn-primary" id="downloadBtn" disabled style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                            Descargar Excel (<span id="selectedCount">0</span>)
                        </button>
                        <button class="btn btn-primary" id="consolidatedBtn" disabled style="padding: 0.5rem 1rem; font-size: 0.85rem; margin-left: 0.5rem;">
                            Listas Consolidadas (<span id="selectedCountConsolidated">0</span>)
                        </button>
                    </div>

                </div>
                <div class="table-wrapper" id="tableWrapper">
                    <!-- Loading indicator -->
                    <div class="loading-indicator" id="loadingIndicator">
                        <div class="loading-spinner"></div>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Cargando APUs...</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Por favor espera un momento</div>
                    </div>
                    
                    <!-- Table -->
                    <table id="apuTable" style="display: none;">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" id="selectAll" style="accent-color: var(--dorado);"></th>
                                <th style="width: 80px;">tem</th>
                                <th>Descripci贸n</th>
                                <th style="width: 100px;">Unidad</th>
                                <th style="width: 120px;">Subregi贸n</th>
                                <th style="width: 140px; text-align: right;">Precio</th>
                            </tr>
                        </thead>
                        <tbody id="apuTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>




    <!-- Main Content -->


    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <h2 id="modalTitle"></h2>
                    <p id="modalSubtitle"></p>
                </div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>



    <!-- Modal de Vista Previa Consolidada -->
    <div class="modal-overlay" id="consolidatedModalOverlay">
        <div class="modal" style="max-width: 95vw; width: 1200px;">
            <div class="modal-header">
                <div class="modal-title">
                    <h2>Vista Previa - Listas Consolidadas</h2>
                    <p>Elementos consolidados de los APUs seleccionados</p>
                </div>
                <button class="modal-close" id="consolidatedModalClose">&times;</button>
            </div>
        <div class="modal-body" style="padding: 1rem;">
            <!-- Navegaci贸n por pesta帽as -->
            <ul class="nav nav-tabs" id="consolidatedTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active consolidatedTab" id="materiales-tab" data-target="materiales-section" type="button">
                        <span class="tab-icon">П</span>
                        <span class="tab-text">Materiales</span>
                        <span class="tab-badge" id="materiales-badge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link consolidatedTab" id="equipos-tab" data-target="equipos-section" type="button">
                        <span class="tab-icon"></span>
                        <span class="tab-text">Equipos</span>
                        <span class="tab-badge" id="equipos-badge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link consolidatedTab" id="transporte-tab" data-target="transporte-section" type="button">
                        <span class="tab-icon"></span>
                        <span class="tab-text">Transportes</span>
                        <span class="tab-badge" id="transporte-badge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link consolidatedTab" id="manoobra-tab" data-target="manoobra-section" type="button">
                        <span class="tab-icon"></span>
                        <span class="tab-text">Mano de<br>Obra</span>
                        <span class="tab-badge" id="manoobra-badge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link consolidatedTab" id="otros-tab" data-target="otros-section" type="button">
                        <span class="tab-icon"></span>
                        <span class="tab-text">Otros</span>
                        <span class="tab-badge" id="otros-badge">0</span>
                    </button>
                </li>
            </ul>




                <!-- Contenido de las pesta帽as -->
                <div class="tab-content" style="border: 2px solid var(--verde-antioquia); border-top: none; border-radius: 0 0 12px 12px; background: white;">
                    <div class="tab-pane show active" id="materiales-section" style="padding: 1rem; max-height: 60vh; overflow-y: auto;">
                        <div id="materiales-content">
                            <!-- Materiales consolidados -->
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="equipos-section" style="padding: 1rem; max-height: 60vh; overflow-y: auto;">
                        <div id="equipos-content">
                            <!-- Equipos consolidados -->
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="transporte-section" style="padding: 1rem; max-height: 60vh; overflow-y: auto;">
                        <div id="transporte-content">
                            <!-- Transportes consolidados -->
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="manoobra-section" style="padding: 1rem; max-height: 60vh; overflow-y: auto;">
                        <div id="manoobra-content">
                            <!-- Mano de obra consolidada -->
                        </div>
                    </div>
                    
                    <div class="tab-pane" id="otros-section" style="padding: 1rem; max-height: 60vh; overflow-y: auto;">
                        <div id="otros-content">
                            <!-- Matrices y trabajos -->
                        </div>
                    </div>
                </div>




                <div style="text-align: center; margin-top: 2rem; padding: 1rem; border-top: 2px solid var(--gris-claro);">
                    <button class="btn btn-primary" id="downloadConsolidatedBtn" style="margin-right: 1rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Descargar Excel
                    </button>
                    <button class="btn btn-secondary" id="cancelConsolidatedBtn">Cancelar</button>
                </div>
            </div>
        </div>
    </div>


    <footer style="background: var(--verde-oscuro); color: var(--blanco); text-align: center; padding: 0.75rem; font-size: 0.75rem; flex-shrink: 0; border-top: 2px solid var(--dorado);">
        <div style="opacity: 0.8;">
            漏 2025 Todos los derechos reservados | Elaborado por Sara Michelle Molina Thomas | Secretar铆a de Infraestructura F铆sica - Departamento de Antioquia
        </div>
    </footer>



    <script>
        // ===== VARIABLES GLOBALES =====
        let allAPUs = [];
        let filteredAPUs = [];
        let selectedAPUs = new Set();

        // ===== DOM ELEMENTS =====
        const searchInput = document.getElementById('searchInput');
        const subregionFilter = document.getElementById('subregionFilter');
        const apuTableBody = document.getElementById('apuTableBody');
        const apuTable = document.getElementById('apuTable');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalClose = document.getElementById('modalClose');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const modalBody = document.getElementById('modalBody');
        const selectAll = document.getElementById('selectAll');
        const downloadBtn = document.getElementById('downloadBtn');
        const consolidatedBtn = document.getElementById('consolidatedBtn');
        const consolidatedModalOverlay = document.getElementById('consolidatedModalOverlay');
        const consolidatedModalClose = document.getElementById('consolidatedModalClose');
        const consolidatedPreviewContent = document.getElementById('consolidatedPreviewContent');
        const downloadConsolidatedBtn = document.getElementById('downloadConsolidatedBtn');
        const cancelConsolidatedBtn = document.getElementById('cancelConsolidatedBtn');



        // ===== INITIALIZATION =====
        async function loadJSONData() {
            try {
                console.log(' Buscando archivos JSON de APUs...');
                
                // Lista de archivos JSON que VIPRA intentar谩 cargar
                const possibleFiles = [
                    // Archivos con fecha actual
                    `APUs_General_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_AMVA_y_Oriente_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Suroeste_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Occidente_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Norte_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Nordeste_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Uraba_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Bajo_Cauca_${new Date().toISOString().split('T')[0]}.json`,
                    `APUs_Magdalena_Medio_${new Date().toISOString().split('T')[0]}.json`,
                    
                    // Archivos gen茅ricos (sin fecha)
                    'APUs_General.json',
                    'APUs_AMVA_y_Oriente.json', 
                    'APUs_Suroeste.json',
                    'APUs_Occidente.json',
                    'APUs_Norte.json',
                    'APUs_Nordeste.json',
                    'APUs_Uraba.json',
                    'APUs_Bajo_Cauca.json',
                    'APUs_Magdalena_Medio.json',
                    
                    // Archivo consolidado original
                    'APUs_Estructurados.json'
                ];
                
                let consolidatedData = {};
                let loadedFiles = [];
                let failedFiles = [];
                
                // Intentar cargar cada archivo
                for (const fileName of possibleFiles) {
                    try {
                        console.log(` Intentando cargar: ${fileName}`);
                        const response = await fetch(fileName);
                        
                        if (response.ok) {
                            const jsonData = await response.json();
                            
                            // Combinar datos con IDs 煤nicos por subregi贸n
                            const newAPUs = Object.keys(jsonData).length;
                            let addedAPUs = 0;
                            
                            Object.entries(jsonData).forEach(([apuId, apuData]) => {
                                // Crear ID 煤nico combinando subregi贸n + ID original
                                const subregion = apuData.subregion || 'Sin_Region';
                                const uniqueId = `${subregion}_${apuId}`;
                                
                                // Solo agregar si no existe (evitar duplicados exactos)
                                if (!consolidatedData[uniqueId]) {
                                    consolidatedData[uniqueId] = {
                                        ...apuData,
                                        originalId: apuId  // Guardar ID original para referencia
                                    };
                                    addedAPUs++;
                                }
                            });
                            
                            loadedFiles.push(`${fileName} (${addedAPUs} APUs 煤nicos)`);
                            console.log(` ${fileName} cargado: ${addedAPUs} APUs 煤nicos de ${newAPUs} totales`);
                        } else {
                            console.log(`锔 ${fileName} no disponible (${response.status})`);
                        }
                    } catch (fileError) {
                        console.log(` Error con ${fileName}:`, fileError.message);
                        failedFiles.push(fileName);
                    }
                }
                
                // Verificar si se carg贸 al menos un archivo
                if (loadedFiles.length === 0) {
                    throw new Error(`No se encontraron archivos JSON. Archivos buscados: ${possibleFiles.slice(0, 5).join(', ')}... y otros.`);
                }
                
                console.log(` Carga completada:`);
                console.log(`    ${loadedFiles.length} archivo(s) cargado(s)`);
                console.log(`    ${Object.keys(consolidatedData).length} APUs totales`);
                loadedFiles.forEach(file => console.log(`      - ${file}`));
                
                // Convertir datos consolidados a formato interno
                allAPUs = Object.entries(consolidatedData).map(([key, data], index) => ({
                    id: index,
                    item: data.originalId || key.split('_').slice(1).join('_') || key, // Mostrar ID original
                    description: data.descripcion || '',
                    unit: data.unidad || 'N/A',
                    subregion: data.subregion || 'Sin especificar',
                    price: data.precio_unitario_total || 0,
                    rawData: data
                }));

                filteredAPUs = [...allAPUs];
                
                // Ocultar loading y mostrar tabla
                loadingIndicator.style.display = 'none';
                apuTable.style.display = 'table';
                
                updateStats();
                populateFilters();
                renderTable();
                
                // Mostrar mensaje de 茅xito
                showLoadingSuccess(loadedFiles);
                
            } catch (error) {
                console.error(' Error cr铆tico cargando archivos JSON:', error);
                
                loadingIndicator.innerHTML = `
                    <div style="color: #d32f2f;">
                        <h3>Error al cargar los datos</h3>
                        <p style="margin: 1rem 0;">${error.message}</p>
                        <div style="font-size: 0.9rem; color: var(--gris-medio); background: #fff3e0; padding: 1rem; border-radius: 8px; text-align: left; max-width: 600px; margin: 0 auto;">
                            <strong>Aseg煤rate de tener al menos uno de estos archivos:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.8rem;">
                                <li><code>APUs_General_${new Date().toISOString().split('T')[0]}.json</code></li>
                                <li><code>APUs_Suroeste_${new Date().toISOString().split('T')[0]}.json</code></li>
                                <li><code>APUs_AMVA_y_Oriente_${new Date().toISOString().split('T')[0]}.json</code></li>
                                <li><code>APUs_Estructurados.json</code> (formato original)</li>
                            </ul>
                            <strong>Nota:</strong> Usa un servidor web local, no abras el HTML directamente.<br>
                            <strong>Ejemplo:</strong> <code>python -m http.server 8000</code>
                        </div>
                    </div>
                `;
            }
        }




        function showLoadingSuccess(loadedFiles) {
            // Crear mensaje temporal de 茅xito
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: linear-gradient(135deg, var(--verde-claro), var(--verde-antioquia)); 
                color: white; 
                padding: 1rem; 
                border-radius: 8px; 
                box-shadow: var(--sombra); 
                z-index: 1000;
                max-width: 300px;
                font-size: 0.9rem;
            `;
            
            successDiv.innerHTML = `
                <strong> Datos cargados exitosamente</strong><br>
                <small>${loadedFiles.length} archivo(s):<br>
                ${loadedFiles.slice(0, 3).map(f => ` ${f.split('(')[0].trim()}`).join('<br>')}
                ${loadedFiles.length > 3 ? '<br> ...' : ''}
                </small>
            `;
            
            document.body.appendChild(successDiv);
            
            // Remover despu茅s de 5 segundos
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 5000);
        }



    async function detectJSONFiles() {
        // Lista de patrones comunes para archivos JSON de APUs
        const commonPatterns = [
            'APUs_General',
            'APUs_AMVA',
            'APUs_Suroeste', 
            'APUs_Occidente',
            'APUs_Norte',
            'APUs_Nordeste',
            'APUs_Uraba',
            'APUs_Bajo_Cauca',
            'APUs_Magdalena_Medio'
        ];
        
        const availableFiles = [];
        const currentDate = new Date().toISOString().split('T')[0];
        
        for (const pattern of commonPatterns) {
            const fileName = `${pattern}_${currentDate}.json`;
            try {
                const response = await fetch(fileName, { method: 'HEAD' });
                if (response.ok) {
                    availableFiles.push(fileName);
                }
            } catch (error) {
                // Archivo no existe, continuar
            }
        }
        
        return availableFiles;
    }



        // ===== STATS UPDATE =====
        function updateStats() {
            document.getElementById('totalApus').textContent = allAPUs.length;
            document.getElementById('filteredCount').textContent = filteredAPUs.length;
            document.getElementById('tableCount').textContent = filteredAPUs.length;
            
            const subregions = new Set(allAPUs.map(apu => apu.subregion));
            document.getElementById('subregionCount').textContent = subregions.size;
        }

        // ===== POPULATE FILTERS =====
        function populateFilters() {
            const subregions = [...new Set(allAPUs.map(apu => apu.subregion))].sort();
            
            subregionFilter.innerHTML = '<option value="">Todas las subregiones</option>';
            subregions.forEach(subregion => {
                const option = document.createElement('option');
                option.value = subregion;
                option.textContent = subregion;
                subregionFilter.appendChild(option);
            });
        }

        // ===== FILTER FUNCTIONS =====
        function filterAPUs() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedSubregion = subregionFilter.value;

            filteredAPUs = allAPUs.filter(apu => {
                const matchesSearch = !searchTerm || 
                    apu.item.toLowerCase().includes(searchTerm) ||
                    apu.description.toLowerCase().includes(searchTerm);
                
                const matchesSubregion = !selectedSubregion || apu.subregion === selectedSubregion;

                return matchesSearch && matchesSubregion;
            });

            updateStats();
            renderTable();
        }

        // ===== RENDER TABLE =====
        function renderTable() {
            apuTableBody.innerHTML = '';

            if (filteredAPUs.length === 0) {
                apuTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">
                            <div>
                                <strong>No se encontraron APUs</strong><br>
                                <span style="font-size: 0.9rem; opacity: 0.8;">
                                    Intenta con otros t茅rminos de b煤squeda o filtros
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            filteredAPUs.forEach(apu => {
                const row = document.createElement('tr');
                row.dataset.id = apu.id;

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="row-checkbox" data-id="${apu.id}" style="accent-color: var(--dorado);">
                    </td>
                    <td>
                        <span class="item-code">${apu.item}</span>
                    </td>
                    <td>
                        <span class="description">${apu.description.length > 80 ? apu.description.substring(0, 80) + '...' : apu.description}</span>
                    </td>
                    <td>
                        <span class="unit-badge">${apu.unit}</span>
                    </td>
                    <td>${apu.subregion}</td>
                    <td class="price">$${formatNumber(apu.price)}</td>
                `;

                apuTableBody.appendChild(row);
            });
        }

        // ===== SHOW APU DETAIL =====
        function showAPUDetail(id) {
            const apu = allAPUs.find(a => a.id === id);
            if (!apu) return;

            modalTitle.textContent = `APU ${apu.item}`;
            modalSubtitle.textContent = apu.description;

            const data = apu.rawData;
                        
            let modalContent = `
                <div class="modal-section" style="margin-bottom: 2rem;">
                    <div class="section-title" style="background: var(--verde-claro); color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px;">
                        INFORMACIN GENERAL
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--gris-claro);">
                                    <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: center;">Subregi贸n</th>
                                    <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: center;">Unidad</th>
                                    <th style="padding: 0.75rem; border: 1px solid #ddd; text-align: center;">Precio Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; font-weight: 600;">${apu.subregion}</td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; font-weight: 600;">${apu.unit}</td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center; font-weight: 600; font-family: monospace; color: var(--verde-claro);">$${formatNumber(apu.price)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Materiales
            if (data.materiales && data.materiales.length > 0) {
                const validMateriales = data.materiales.filter(item => 
                    item.descripcion && item.descripcion !== 'ITEM' && 
                    item.valor_unitario !== null && item.valor_unitario !== undefined
                );
                
                if (validMateriales.length > 0) {
                    const totalMateriales = validMateriales.reduce((sum, item) => sum + (item.valor_unitario || 0), 0);
                    
                    modalContent += `
                        <div class="modal-section" style="margin-bottom: 2rem;">
                            <div class="section-title" style="background: var(--verde-claro); color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px;">
                                MATERIALES (${validMateriales.length} elementos)
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: var(--gris-claro);">
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left; min-width: 200px;">Descripci贸n</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center; width: 80px;">Unidad</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 100px;">Cantidad</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Precio Unitario</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Valor Unitario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    validMateriales.forEach(item => {
                        modalContent += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 0.5rem; border: 1px solid #ddd;">${item.descripcion}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${item.unidad || 'N/A'}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">${formatNumber(item.cantidad)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.precio_tarifa)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace; font-weight: 600;">$${formatNumber(item.valor_unitario)}</td>
                            </tr>
                        `;
                    });
                    
                    modalContent += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: var(--dorado-suave); font-weight: bold;">
                                            <td colspan="4" style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">TOTAL MATERIALES:</td>
                                            <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(totalMateriales)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }

            // Equipos
            if (data.equipos && data.equipos.length > 0) {
                const validEquipos = data.equipos.filter(item => 
                    item.descripcion && item.descripcion !== 'ITEM' && 
                    item.valor_unitario !== null && item.valor_unitario !== undefined
                );
                
                if (validEquipos.length > 0) {
                    const totalEquipos = validEquipos.reduce((sum, item) => sum + (item.valor_unitario || 0), 0);
                    
                    modalContent += `
                        <div class="modal-section" style="margin-bottom: 2rem;">
                            <div class="section-title" style="background: var(--verde-claro); color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px;">
                                EQUIPOS (${validEquipos.length} elementos)
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: var(--gris-claro);">
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left; min-width: 200px;">Descripci贸n</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center; width: 80px;">Tipo</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 100px;">Tarifa/Hora-D铆a</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Rendimiento</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Valor Unitario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    validEquipos.forEach(item => {
                        modalContent += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 0.5rem; border: 1px solid #ddd;">${item.descripcion}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;"></td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.cantidad)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">${formatNumber(item.precio_tarifa)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace; font-weight: 600;">$${formatNumber(item.valor_unitario)}</td>
                            </tr>
                        `;
                    });
                    
                    modalContent += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: var(--dorado-suave); font-weight: bold;">
                                            <td colspan="4" style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">TOTAL EQUIPOS:</td>
                                            <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(totalEquipos)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }

            // Mano de obra
            if (data.mano_obra && data.mano_obra.length > 0) {
                const validManoObra = data.mano_obra.filter(item => 
                    item.descripcion && item.descripcion !== 'ITEM' && 
                    item.valor_unitario !== null && item.valor_unitario !== undefined
                );
                
                if (validManoObra.length > 0) {
                    const totalManoObra = validManoObra.reduce((sum, item) => sum + (item.valor_unitario || 0), 0);
                    
                    modalContent += `
                        <div class="modal-section" style="margin-bottom: 2rem;">
                            <div class="section-title" style="background: var(--verde-claro); color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px;">
                                MANO DE OBRA (${validManoObra.length} elementos)
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: var(--gris-claro);">
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left; min-width: 200px;">Descripci贸n</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center; width: 80px;">Jornal</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 100px;">Jornal Total (+ Prestaciones)</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Rendimiento</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Valor Unitario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    validManoObra.forEach(item => {
                        modalContent += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 0.5rem; border: 1px solid #ddd;">${item.descripcion}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">$${formatNumber(item.unidad) || 'N/A'}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.cantidad)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">${formatNumber(item.precio_tarifa)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace; font-weight: 600;">$${formatNumber(item.valor_unitario)}</td>
                            </tr>
                        `;
                    });
                    
                    modalContent += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: var(--dorado-suave); font-weight: bold;">
                                            <td colspan="4" style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">TOTAL MANO DE OBRA:</td>
                                            <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(totalManoObra)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }

            // Transporte
            if (data.transporte && data.transporte.length > 0) {
                const validTransporte = data.transporte.filter(item => 
                    item.descripcion && item.descripcion !== 'ITEM' && 
                    item.valor_unitario !== null && item.valor_unitario !== undefined
                );
                
                if (validTransporte.length > 0) {
                    const totalTransporte = validTransporte.reduce((sum, item) => sum + (item.valor_unitario || 0), 0);
                    
                    modalContent += `
                        <div class="modal-section" style="margin-bottom: 2rem;">
                            <div class="section-title" style="background: var(--verde-claro); color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px;">
                                TRANSPORTE (${validTransporte.length} elementos)
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: var(--gris-claro);">
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left; min-width: 200px;">Descripci贸n</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center; width: 80px;">Distancia</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 100px;">Cantidad (m3-Km / ton-Km)</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Tarifa</th>
                                            <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; width: 120px;">Valor Unitario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    validTransporte.forEach(item => {
                        modalContent += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 0.5rem; border: 1px solid #ddd;">${item.descripcion}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${item.unidad || 'N/A'}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">${formatNumber(item.cantidad)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.precio_tarifa)}</td>
                                <td style="padding: 0.5rem; border: 1px solid #ddd; text-align: right; font-family: monospace; font-weight: 600;">$${formatNumber(item.valor_unitario)}</td>
                            </tr>
                        `;
                    });
                    
                    modalContent += `
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: var(--dorado-suave); font-weight: bold;">
                                            <td colspan="4" style="padding: 0.75rem; border: 1px solid #ddd; text-align: right;">TOTAL TRANSPORTE:</td>
                                            <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(totalTransporte)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }

            modalBody.innerHTML = modalContent;
            modalOverlay.classList.add('active');

        }

        // ===== RENDER DETAIL SECTION =====
        function renderDetailSection(title, data) {
            const validData = data.filter(item => 
                item.descripcion && 
                item.descripcion !== 'ITEM' && 
                item.valor_unitario !== null && 
                item.valor_unitario !== undefined
            );

            if (validData.length === 0) {
                return `
                    <div class="modal-section">
                        <div class="section-title">${title}</div>
                        <div class="no-data">No hay ${title.toLowerCase()} registrados</div>
                    </div>
                `;
            }

            let tableRows = validData.map(item => `
                <tr>
                    <td>${item.descripcion}</td>
                    <td>${item.unidad || 'N/A'}</td>
                    <td class="numeric">${formatNumber(item.cantidad)}</td>
                    <td class="numeric">$${formatNumber(item.precio_tarifa)}</td>
                    <td class="numeric">$${formatNumber(item.valor_unitario)}</td>
                </tr>
            `).join('');

            return `
                <div class="modal-section">
                    <div class="section-title">${title}</div>
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>Descripci贸n</th>
                                <th>Unidad</th>
                                <th class="numeric">Cantidad</th>
                                <th class="numeric">Precio Tarifa</th>
                                <th class="numeric">Valor Unitario</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ===== UTILITY FUNCTIONS =====
        function formatNumber(number) {
            if (number === null || number === undefined) return 'N/A';
            return new Intl.NumberFormat('es-CO').format(number);
        }

        // ===== EVENT LISTENERS =====
        searchInput.addEventListener('input', filterAPUs);
        subregionFilter.addEventListener('change', filterAPUs);

        apuTableBody.addEventListener('click', (e) => {
            // Si es un checkbox, no hacer nada (ya se maneja en el evento 'change')
            if (e.target.type === 'checkbox') return;
            
            const row = e.target.closest('tr');
            if (!row || !row.dataset.id) return;
            const id = parseInt(row.dataset.id);
            showAPUDetail(id);
        });

        modalClose.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                modalOverlay.classList.remove('active');
            }
        });

        consolidatedBtn.addEventListener('click', showConsolidatedPreview);

        // Select all functionality
        selectAll.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                const id = parseInt(cb.dataset.id);
                if (e.target.checked) {
                    selectedAPUs.add(id);
                } else {
                    selectedAPUs.delete(id);
                }
            });
            updateSelectionCount();
        });

        // Individual checkbox handling
        apuTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('row-checkbox')) {
                const id = parseInt(e.target.dataset.id);
                if (e.target.checked) {
                    selectedAPUs.add(id);
                } else {
                    selectedAPUs.delete(id);
                }
                updateSelectionCount();
                
                // Update select all checkbox
                const totalVisible = document.querySelectorAll('.row-checkbox').length;
                const totalSelected = document.querySelectorAll('.row-checkbox:checked').length;
                selectAll.indeterminate = totalSelected > 0 && totalSelected < totalVisible;
                selectAll.checked = totalSelected === totalVisible && totalVisible > 0;
            }
        });

        // Download button
        downloadBtn.addEventListener('click', downloadExcel);

        // Event listeners para modal consolidado
        consolidatedModalClose.addEventListener('click', () => {
            consolidatedModalOverlay.classList.remove('active');
        });

        cancelConsolidatedBtn.addEventListener('click', () => {
            consolidatedModalOverlay.classList.remove('active');
        });

        downloadConsolidatedBtn.addEventListener('click', () => {
            consolidatedModalOverlay.classList.remove('active');
            exportConsolidatedLists();
        });

        consolidatedModalOverlay.addEventListener('click', (e) => {
            if (e.target === consolidatedModalOverlay) {
                consolidatedModalOverlay.classList.remove('active');
            }
        });

        // Actualizar contador de seleccionados
        function updateSelectionCount() {
            const count = selectedAPUs.size;
            document.getElementById('selectedCount').textContent = count;
            downloadBtn.disabled = count === 0;
            document.getElementById('selectedCountConsolidated').textContent = count;
            consolidatedBtn.disabled = count === 0;
        }


        // Funcionalidad para pesta帽as del modal consolidado
        document.querySelectorAll('.consolidatedTab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remover active de todas las pesta帽as
                document.querySelectorAll('.consolidatedTab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
                
                // Activar pesta帽a clickeada
                this.classList.add('active');
                const targetId = this.getAttribute('data-target');
                const targetPane = document.getElementById(targetId);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                }
            });
        });



        // Funci贸n de descarga Excel
        function downloadExcel() {
            if (selectedAPUs.size === 0) return;
            
            const selectedData = Array.from(selectedAPUs).map(id => {
                const apu = allAPUs.find(a => a.id === id);
                return apu ? apu.rawData : null;
            }).filter(Boolean);
            
            const wb = XLSX.utils.book_new();
            
            selectedData.forEach((data, index) => {
                const apu = allAPUs.find(a => a.rawData === data);
                const sheetData = [];

                // Header principal - TEM, DESCRIPCIN, UNIDAD
                sheetData.push(['', 'ANLISIS DE PRECIOS UNITARIOS', '', '', '', '', 'Proceso:', 'LIC - CCCCC', '']);
                sheetData.push(['', '', '', '', '', '', 'Fecha Lic:', '20/03/2025', '']);
                sheetData.push(['', '', '', '', '', '', 'Versi贸n:', '', '']);
                sheetData.push(['', '', '', '', '', '', 'P谩gina:', '1 de 1', '']);
                sheetData.push(['', '', '', '', '', '', '', '', '']);

                sheetData.push(['An谩lisis de Precios Unitarios para las Subregiones de Occidente, Bajo Cauca, Magdalena Medio, Norte, Nordeste y Urab谩 del Departamento de Antioquia', '', '', '', '', '', '', '', '']);

                sheetData.push(['', '', '', '', '', '', '', '', '']);

                sheetData.push(['TEM', 'DESCRIPCIN', '', '', '', '', '', '', 'UNIDAD']);
                sheetData.push([apu.item, data.descripcion || '', '', '', '', '', '', '', data.unidad || '']);
                sheetData.push(['', '', '', '', '', '', '', '', '']); // L铆nea vac铆a
                
                // I. EQUIPO
                if (data.equipos && data.equipos.length > 0) {
                    const validEquipos = data.equipos.filter(item => item.descripcion && item.descripcion !== 'ITEM');
                    if (validEquipos.length > 0) {
                        sheetData.push(['I. EQUIPO', '', '', '', '', '', '', '', '']);
                        sheetData.push(['Descripci贸n', '', '', '', 'Marca', 'Tipo', 'Tarifa/Hora-D铆a', 'Rendimiento', 'Valor-Unit']);
                        
                        let subtotalEquipos = 0;
                        validEquipos.forEach(item => {
                            const valorUnit = item.valor_unitario || 0;
                            subtotalEquipos += valorUnit;
                            sheetData.push([
                                item.descripcion || '','',
                                '', '', // Espacios para combinar descripci贸n
                                '', // Marca
                                '', // Tipo
                                `$${formatNumber(item.precio_tarifa)}`,
                                formatNumber(item.cantidad),
                                `$${formatNumber(valorUnit)}`
                            ]);
                        });
                        sheetData.push(['', '', '', '', '', '', '', 'Sub-Total', `$${formatNumber(subtotalEquipos)}`]);
                        sheetData.push(['', '', '', '', '', '', '', '', '']); // L铆nea vac铆a
                    }
                }
                
                // II. MATERIALES
                if (data.materiales && data.materiales.length > 0) {
                    const validMateriales = data.materiales.filter(item => item.descripcion && item.descripcion !== 'ITEM');
                    if (validMateriales.length > 0) {
                        sheetData.push(['II. MATERIALES', '', '', '', '', '', '', '', '']);
                        sheetData.push(['Descripci贸n', '', '', '', '', 'Unidad', 'Cantidad', 'Precio-Unit', 'Valor-Unit']);
                        
                        let subtotalMateriales = 0;
                        validMateriales.forEach(item => {
                            const valorUnit = item.valor_unitario || 0;
                            subtotalMateriales += valorUnit;
                            sheetData.push([
                                item.descripcion || '','',
                                '', '', '', // Espacios para combinar descripci贸n
                                item.unidad || '',
                                formatNumber(item.cantidad),
                                `$${formatNumber(item.precio_tarifa)}`,
                                `$${formatNumber(valorUnit)}`
                            ]);
                        });
                        sheetData.push(['', '', '', '', '', '',  '', 'Sub-Total', `$${formatNumber(subtotalMateriales)}`]);
                        sheetData.push(['', '', '', '', '', '', '', '', '']); // L铆nea vac铆a
                    }
                }
                
                // III. TRANSPORTES
                if (data.transporte && data.transporte.length > 0) {
                    const validTransportes = data.transporte.filter(item => item.descripcion && item.descripcion !== 'ITEM');
                    if (validTransportes.length > 0) {
                        sheetData.push(['III. TRANSPORTES', '', '', '', '', '', '', '', '']);
                        sheetData.push(['Descripci贸n', '', 'Volumen (m3) - Peso (ton)', 'Distancia', 'Cantidad (m3-Km / ton-Km)', 'Tarifa', 'Valor-Unit', '', '']);
                        
                        let subtotalTransportes = 0;
                        validTransportes.forEach(item => {
                            const valorUnit = item.valor_unitario || 0;
                            subtotalTransportes += valorUnit;
                            sheetData.push([
                                item.descripcion || '',
                                '', // Espacio para combinar descripci贸n
                                '', // Volumen
                                '', // Distancia
                                formatNumber(item.cantidad),
                                `$${formatNumber(item.precio_tarifa)}`,
                                `$${formatNumber(valorUnit)}`,
                                '', ''
                            ]);
                        });
                        sheetData.push(['', '', '', '', '', 'Sub-Total', `$${formatNumber(subtotalTransportes)}`]);
                        sheetData.push(['', '', '', '', '', '', '', '']); // L铆nea vac铆a
                    }
                }
                
                // IV. MANO DE OBRA
                if (data.mano_obra && data.mano_obra.length > 0) {
                    const validManoObra = data.mano_obra.filter(item => item.descripcion && item.descripcion !== 'ITEM');
                    if (validManoObra.length > 0) {
                        sheetData.push(['IV. MANO DE OBRA', '', '', '', '', '', '', '', '']);
                        sheetData.push(['Descripci贸n', '', '', '', '', 'Jornal', 'Jornal Total (+ Prestaciones)', 'Rendimiento', 'Valor-Unit']);
                        
                        let subtotalManoObra = 0;
                        validManoObra.forEach(item => {
                            const valorUnit = item.valor_unitario || 0;
                            subtotalManoObra += valorUnit;
                            sheetData.push([
                                item.descripcion || '','','',
                                '', '', // Espacios para combinar descripci贸n
                                `$${formatNumber(item.unidad)}`,
                                `$${formatNumber(item.cantidad)}`,
                                formatNumber(item.precio_tarifa),
                                `$${formatNumber(valorUnit)}`
                            ]);
                        });
                        sheetData.push(['', '', '', '', '', '', '', 'Sub-Total', `$${formatNumber(subtotalManoObra)}`]);
                        sheetData.push(['', '', '', '', '', '', '', '', '']); // L铆nea vac铆a
                    }
                }
                
                // Total Costo Directo
                sheetData.push(['', '', '', '', '', '', '', 'Total Costo Directo', `$${formatNumber(data.precio_unitario_total)}`]);
                sheetData.push(['', '', '', '', '', '', '', '', '']); // L铆nea vac铆a
                
                // V. COSTOS INDIRECTOS
                sheetData.push(['V. COSTOS INDIRECTOS', '', '', '', '', '', '', '', '']);
                sheetData.push(['Descripci贸n', '', '', '', '', '', '', 'Porcentaje', 'Valor Total']);
                sheetData.push(['ADMINISTRACION', '', '', '', '', '', '', '0,00%', '$0']);
                sheetData.push(['UTILIDAD', '', '', '', '', '', '', '0,00%', '$0']);
                sheetData.push(['IMPREVISTOS', '', '', '', '', '', '', '0,00%', '$0']);
                sheetData.push(['Total sobrecostos', '', '', '', '', '', '', '', '$0']);
                sheetData.push(['', '', '', '', '', '', 'Sub-Total', '0,00%', '$0']);
                sheetData.push(['', '', '', '', '', '', '', '', '']);
                
                // Precio unitario total aproximado al peso
                sheetData.push(['', '', '', '', '','','', 'Precio unitario total aproximado al peso', `$${formatNumber(data.precio_unitario_total)}`]);
                
                // Crear hoja
                const ws = XLSX.utils.aoa_to_sheet(sheetData);

                // Funci贸n para aplicar estilo con bordes
                const applyStyleToCell = (cellRef, font = {}, fill = null, alignment = {}) => {
                    if (!ws[cellRef]) {
                        ws[cellRef] = { v: "" }; // Crear celda si no existe
                    }
                    ws[cellRef].s = {
                        font: { name: "Arial", sz: 10, ...font },
                        fill: fill ? { fgColor: { rgb: fill } } : undefined,
                        alignment: { horizontal: "center", vertical: "center", ...alignment },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                };

                // Desactivar l铆neas de cuadr铆cula
                if (!ws['!views']) ws['!views'] = [{}];
                ws['!views'][0] = { showGridLines: false };
                
                // Aplicar combinaciones de celdas
                ws['!merges'] = [
                    // Header principal
                    { s: { r: 0, c: 1 }, e: { r: 3, c: 5 } },
                    { s: { r: 0, c: 7 }, e: { r: 0, c: 8 } },
                    { s: { r: 1, c: 7 }, e: { r: 1, c: 8 } }, 
                    { s: { r: 2, c: 7 }, e: { r: 2, c: 8 } }, 
                    { s: { r: 3, c: 7 }, e: { r: 3, c: 8 } }, 
                    { s: { r: 0, c: 0 }, e: { r: 3, c: 0 } }, 
                    { s: { r: 5, c: 0 }, e: { r: 5, c: 8 } }, 
                    { s: { r: 7, c: 1 }, e: { r: 7, c: 7 } }, 
                    { s: { r: 8, c: 1 }, e: { r: 8, c: 7 } }, 
                    
                    // T铆tulos de secciones y descripciones de equipos
                    ...sheetData.map((row, idx) => {
                        if (row[0] && row[0].includes('I. EQUIPO')) {
                            return { s: { r: idx, c: 0 }, e: { r: idx, c: 8 } }; // Toda la fila
                        }
                        if (row[0] && (row[0].includes('II. MATERIALES') || 
                            row[0].includes('III. TRANSPORTES') || row[0].includes('IV. MANO DE OBRA') || 
                            row[0].includes('V. COSTOS INDIRECTOS'))) {
                            return { s: { r: idx, c: 0 }, e: { r: idx, c: 8 } }; // Toda la fila
                        }
                        
                        // Combinar descripciones de equipos (A a D)
                        if (row[0] && row[0] !== 'Descripci贸n' && row[0] !== '' && idx > 0) {
                            const equipoSectionStart = sheetData.findIndex(r => r[0] && r[0].includes('I. EQUIPO'));
                            const materialesSectionStart = sheetData.findIndex(r => r[0] && r[0].includes('II. MATERIALES'));
                            
                            if (equipoSectionStart !== -1 && idx > equipoSectionStart && 
                                (materialesSectionStart === -1 || idx < materialesSectionStart)) {
                                return { s: { r: idx, c: 0 }, e: { r: idx, c: 3 } };
                            }
                            
                            // Combinar descripciones de materiales (A a E)
                            const transportesSectionStart = sheetData.findIndex(r => r[0] && r[0].includes('III. TRANSPORTES'));
                            if (materialesSectionStart !== -1 && idx > materialesSectionStart && 
                                (transportesSectionStart === -1 || idx < transportesSectionStart)) {
                                return { s: { r: idx, c: 0 }, e: { r: idx, c: 4 } };
                            }
                            
                            // Combinar descripciones de transportes (A a B)
                            const manoObraSectionStart = sheetData.findIndex(r => r[0] && r[0].includes('IV. MANO DE OBRA'));
                            if (transportesSectionStart !== -1 && idx > transportesSectionStart && 
                                (manoObraSectionStart === -1 || idx < manoObraSectionStart)) {
                                return { s: { r: idx, c: 0 }, e: { r: idx, c: 1 } };
                            }
                            
                            // Combinar descripciones de mano de obra (A a E)
                            const costosIndirectosStart = sheetData.findIndex(r => r[0] && r[0].includes('V. COSTOS INDIRECTOS'));
                            if (manoObraSectionStart !== -1 && idx > manoObraSectionStart && 
                                (costosIndirectosStart === -1 || idx < costosIndirectosStart)) {
                                return { s: { r: idx, c: 0 }, e: { r: idx, c: 4 } };
                            }
                        }
                        
                        return null;
                    }).filter(Boolean)
                ];
                
                // Aplicar bordes a TODAS las celdas con datos
                sheetData.forEach((row, rowIdx) => {
                    row.forEach((cell, colIdx) => {
                        if (cell && cell !== '') { // Solo si la celda tiene contenido
                            const cellRef = XLSX.utils.encode_cell({ r: rowIdx, c: colIdx });
                            
                            // Aplicar estilo b谩sico con bordes
                            applyStyleToCell(cellRef);
                            
                            // Aplicar estilos espec铆ficos seg煤n el contenido
                            
                            // Header principal (filas 0-3)
                            if (rowIdx >= 0 && rowIdx <= 3) {
                                applyStyleToCell(cellRef, { bold: true }, "D9D9D9", { horizontal: "center" });
                            }
                            
                            // T铆tulo descriptivo (fila 5)
                            else if (rowIdx === 5) {
                                applyStyleToCell(cellRef, { bold: true }, "E8F5E8", { horizontal: "center" });
                            }
                            
                            // Headers TEM/DESCRIPCIN/UNIDAD (fila 7)
                            else if (rowIdx === 7) {
                                applyStyleToCell(cellRef, { bold: true }, "D9D9D9", { horizontal: "center" });
                            }
                            
                            // Contenido TEM/DESCRIPCIN/UNIDAD (fila 8)
                            else if (rowIdx === 8) {
                                applyStyleToCell(cellRef, { bold: true }, "F9F9F9", { horizontal: "center" });
                            }
                            
                            // T铆tulos de secciones
                            else if (cell.includes('I. ') || cell.includes('II. ') || 
                                    cell.includes('III. ') || cell.includes('IV. ') || cell.includes('V. ')) {
                                applyStyleToCell(cellRef, { bold: true }, "F2F2F2", { horizontal: "left" });
                            }
                            
                            // Headers de tablas
                            else if (['Descripci贸n', 'Marca', 'Tipo', 'Unidad', 'Cantidad', 'Precio-Unit', 
                                    'Valor-Unit', 'Tarifa/Hora-D铆a', 'Rendimiento', 'Jornal', 
                                    'Porcentaje', 'Valor Total'].includes(cell)) {
                                applyStyleToCell(cellRef, { bold: true }, "D9D9D9", { horizontal: "center" });
                            }
                            
                            // Subtotales
                            else if (cell.includes('Sub-Total') || cell.includes('Total Costo Directo')) {
                                applyStyleToCell(cellRef, { bold: true }, null, { horizontal: "right" });
                            }
                            
                            // Precio final
                            else if (cell.includes('Precio unitario total aproximado al peso')) {
                                applyStyleToCell(cellRef, { bold: true }, "FFFF99", { horizontal: "right" });
                            }
                        }
                    });
                });
                
                // Configurar anchos de columna
                ws['!cols'] = [
                    {wch: 12}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}, 
                    {wch: 12}, {wch: 15}, {wch: 18}, {wch: 15}
                ];

                // Nombre de la hoja 煤nico incluyendo subregi贸n
            const cleanSubregion = apu.subregion.replace(/[^a-zA-Z0-9]/g, '').substring(0, 10);
            let sheetName = `${cleanSubregion}_${apu.item}`.substring(0, 31).replace(/[\\\/\?\*\[\]:]/g, '_');

            // Verificar si ya existe y agregar n煤mero si es necesario
            let counter = 1;
            let originalSheetName = sheetName;
            while (wb.SheetNames.includes(sheetName)) {
                sheetName = `${originalSheetName.substring(0, 28)}_${counter}`;
                counter++;
            }

            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            // ========== AGREGAR LISTAS CONSOLIDADAS ==========
            
            // Funci贸n para consolidar elementos
            function consolidateElements(category) {
                const consolidated = {};
                
                // Mapear datos con c贸digos de APU
                const selectedDataWithCodes = Array.from(selectedAPUs).map(id => {
                    const apu = allAPUs.find(a => a.id === id);
                    return apu ? { codigo: apu.item, data: apu.rawData } : null;
                }).filter(Boolean);
                
                selectedDataWithCodes.forEach(({ codigo, data }) => {
                    const elements = data[category] || [];
                    elements.forEach(item => {
                        if (!item.descripcion || item.descripcion === 'ITEM') return;
                        
                        const key = `${item.descripcion}_${item.unidad}_${item.precio_tarifa}`;
                        
                        if (!consolidated[key]) {
                            consolidated[key] = {
                                descripcion: item.descripcion,
                                unidad: item.unidad || 'N/A',
                                cantidad: 0,
                                precio_tarifa: item.precio_tarifa || 0,
                                valor_total: 0,
                                apus: new Set(),
                                precio_unitario_promedio: item.precio_tarifa || 0
                            };
                        }
                        
                        consolidated[key].cantidad += (item.cantidad || 0);
                        consolidated[key].valor_total += (item.valor_unitario || 0);
                        consolidated[key].apus.add(codigo);
                    });
                });
                
                return Object.values(consolidated).map(item => ({
                    ...item,
                    apus: Array.from(item.apus).sort().join(', '),
                    frecuencia: item.apus.size
                })).sort((a, b) => a.descripcion.localeCompare(b.descripcion));
            }
            
            // Crear listas consolidadas
            const categories = [
                { name: 'materiales', title: 'LISTA_MATERIALES' },
                { name: 'equipos', title: 'LISTA_EQUIPOS' },
                { name: 'mano_obra', title: 'LISTA_MANO_OBRA' },
                { name: 'transporte', title: 'LISTA_TRANSPORTES' },
                { name: 'matrices', title: 'LISTA_MATRICES' },
                { name: 'trabajos', title: 'LISTA_TRABAJOS' }
            ];
            
            let resumenData = [];
            
            categories.forEach(({ name, title }) => {
                const consolidated = consolidateElements(name);
                
                if (consolidated.length > 0) {
                    // Crear hoja para esta categor铆a
                    const sheetData = [];
                    
                    // Header
                    sheetData.push([title, '', '', '', '', '', '']);
                    sheetData.push(['', '', '', '', '', '', '']);
                    sheetData.push(['Descripci贸n', 'Unidad', 'Cantidad Total', 'Precio Unit.', 'Valor Total', 'APUs que lo usan', 'Frecuencia']);
                    
                    let totalValor = 0;
                    consolidated.forEach(item => {
                        totalValor += item.valor_total;
                        sheetData.push([
                            item.descripcion,
                            item.unidad,
                            formatNumber(item.cantidad),
                            `$${formatNumber(item.precio_unitario_promedio)}`,
                            `$${formatNumber(item.valor_total)}`,
                            item.apus,
                            item.frecuencia
                        ]);
                    });
                    
                    // Total
                    sheetData.push(['', '', '', 'TOTAL:', `$${formatNumber(totalValor)}`, '', '']);
                    
                    // Crear worksheet
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    
                    // Desactivar l铆neas de cuadr铆cula
                    if (!ws['!views']) ws['!views'] = [{}];
                    ws['!views'][0] = { showGridLines: false };
                    
                    // Aplicar estilos
                    const headerStyle = {
                        font: { bold: true, sz: 12 },
                        fill: { fgColor: { rgb: "D9D9D9" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                    
                    const titleStyle = {
                        font: { bold: true, sz: 14 },
                        fill: { fgColor: { rgb: "4F81BD" } },
                        alignment: { horizontal: "center", vertical: "center" },
                        border: {
                            top: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        }
                    };
                    
                    // Aplicar estilos
                    ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1'].forEach(cell => {
                        if (!ws[cell]) ws[cell] = { v: "" };
                        ws[cell].s = titleStyle;
                    });
                    
                    ['A3', 'B3', 'C3', 'D3', 'E3', 'F3', 'G3'].forEach(cell => {
                        if (!ws[cell]) ws[cell] = { v: "" };
                        ws[cell].s = headerStyle;
                    });
                    
                    // Combinar t铆tulo
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }];
                    
                    // Configurar anchos
                    ws['!cols'] = [
                        {wch: 45}, {wch: 12}, {wch: 15}, {wch: 15}, 
                        {wch: 15}, {wch: 25}, {wch: 12}
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, title);
                    
                    resumenData.push({
                        categoria: title,
                        elementos: consolidated.length,
                        valor_total: totalValor
                    });
                }
            });
            
            // Crear hoja de resumen
            if (resumenData.length > 0) {
                const resumenSheet = [];
                resumenSheet.push(['RESUMEN CONSOLIDADO', '', '', '']);
                resumenSheet.push(['', '', '', '']);
                resumenSheet.push(['Categor铆a', 'Elementos', 'Valor Total', 'Porcentaje']);
                
                const totalGeneral = resumenData.reduce((sum, item) => sum + item.valor_total, 0);
                
                resumenData.forEach(item => {
                    const porcentaje = totalGeneral > 0 ? (item.valor_total / totalGeneral * 100).toFixed(2) : 0;
                    resumenSheet.push([
                        item.categoria,
                        item.elementos,
                        `$${formatNumber(item.valor_total)}`,
                        `${porcentaje}%`
                    ]);
                });
                
                resumenSheet.push(['TOTAL GENERAL', '', `$${formatNumber(totalGeneral)}`, '100%']);
                
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenSheet);
                
                if (!wsResumen['!views']) wsResumen['!views'] = [{}];
                wsResumen['!views'][0] = { showGridLines: false };
                
                wsResumen['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }];
                wsResumen['!cols'] = [{wch: 20}, {wch: 15}, {wch: 20}, {wch: 15}];
                
                XLSX.utils.book_append_sheet(wb, wsResumen, 'RESUMEN_CONSOLIDADO');
            }
            
            // Descargar archivo
            XLSX.writeFile(wb, `APUs_Seleccionados_${new Date().toISOString().split('T')[0]}.xlsx`);
        }





        // Funci贸n para mostrar vista previa consolidada
        function showConsolidatedPreview() {
            if (selectedAPUs.size === 0) return;
            
            const selectedData = Array.from(selectedAPUs).map(id => {
                const apu = allAPUs.find(a => a.id === id);
                return apu ? { codigo: apu.item, data: apu.rawData } : null;
            }).filter(Boolean);
            
            // Funci贸n para consolidar elementos (simplificada)
            function consolidateElements(category) {
                const consolidated = {};
                
                selectedData.forEach(({ codigo, data }) => {
                    const elements = data[category] || [];
                    elements.forEach(item => {
                        if (!item.descripcion || item.descripcion === 'ITEM') return;
                        
                        const key = item.descripcion;
                        
                        if (!consolidated[key]) {
                            consolidated[key] = {
                                descripcion: item.descripcion,
                                unidad: item.unidad || 'N/A',
                                precio_tarifa: item.precio_tarifa || 0,
                                jornal: item.jornal || 0,
                                jornal_total: item.jornal_total || 0,
                                tarifa_hora_dia: item.tarifa_hora_dia || item.precio_tarifa || 0,
                                cantidad: 0,
                                apus: new Set()
                            };
                        }
                        
                        consolidated[key].cantidad += (item.cantidad || 0);
                        consolidated[key].apus.add(codigo);
                    });
                });
                
                return Object.values(consolidated).map(item => ({
                    ...item,
                    apus: Array.from(item.apus).sort().join(', '),
                    frecuencia: item.apus.size
                })).sort((a, b) => a.descripcion.localeCompare(b.descripcion));
            }
            
            // Consolidar por categor铆as
            const materialesConsolidados = consolidateElements('materiales');
            const equiposConsolidados = consolidateElements('equipos');
            const manoObraConsolidada = consolidateElements('mano_obra');
            const transportesConsolidados = consolidateElements('transporte');
            const matricesConsolidadas = consolidateElements('matrices');
            const trabajosConsolidados = consolidateElements('trabajos');
            
            // Funci贸n para crear tabla de MATERIALES
            function createMaterialesTable(items) {
                if (items.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: var(--gris-medio);">No hay materiales para mostrar.</div>';
                }
                
                return `
                    <div class="section-title-tab">Materiales Consolidados (${items.length} elementos)</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--verde-antioquia); color: white;">
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: left;">Descripci贸n</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Unidad</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Precio Unitario</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 0.75rem; border: 1px solid #ddd;"><strong>${item.descripcion}</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center;">${item.unidad}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.precio_tarifa)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Funci贸n para crear tabla de EQUIPOS
            function createEquiposTable(items) {
                if (items.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: var(--gris-medio);">No hay equipos para mostrar.</div>';
                }
                
                return `
                    <div class="section-title-tab">Equipos Consolidados (${items.length} elementos)</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--verde-antioquia); color: white;">
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: left;">Descripci贸n</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Tarifa/Hora-D铆a</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 0.75rem; border: 1px solid #ddd;"><strong>${item.descripcion}</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.tarifa_hora_dia)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Funci贸n para crear tabla de TRANSPORTES
            function createTransportesTable(items) {
                if (items.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: var(--gris-medio);">No hay transportes para mostrar.</div>';
                }
                
                return `
                    <div class="section-title-tab">Transportes Consolidados (${items.length} elementos)</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--verde-antioquia); color: white;">
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: left;">Descripci贸n</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Tarifa</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 0.75rem; border: 1px solid #ddd;"><strong>${item.descripcion}</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.precio_tarifa)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Funci贸n para crear tabla de MANO DE OBRA
            function createManoObraTable(items) {
                if (items.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: var(--gris-medio);">No hay mano de obra para mostrar.</div>';
                }
                
                return `
                    <div class="section-title-tab">Mano de Obra Consolidada (${items.length} elementos)</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--verde-antioquia); color: white;">
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: left;">Descripci贸n</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Jornal</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Jornal Total (+ Prestaciones)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 0.75rem; border: 1px solid #ddd;"><strong>${item.descripcion}</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.jornal)}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.jornal_total)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Funci贸n para crear tabla de OTROS (Matrices y Trabajos)
            function createOtrosTable(matrices, trabajos) {
                const todosItems = [
                    ...matrices.map(item => ({...item, tipo: 'Matriz'})),
                    ...trabajos.map(item => ({...item, tipo: 'Trabajo'}))
                ].sort((a, b) => a.tipo.localeCompare(b.tipo) || a.descripcion.localeCompare(b.descripcion));
                
                if (todosItems.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: var(--gris-medio);">No hay otros elementos para mostrar.</div>';
                }
                
                return `
                    <div class="section-title-tab">Otros Elementos (${todosItems.length} elementos)</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--verde-antioquia); color: white;">
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Tipo</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: left;">Descripci贸n</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Unidad</th>
                                    <th style="padding: 1rem; border: 1px solid #ddd; text-align: center;">Precio Unit.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${todosItems.map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center;">
                                            <span style="background: ${item.tipo === 'Matriz' ? 'var(--dorado)' : 'var(--verde-claro)'}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">
                                                ${item.tipo}
                                            </span>
                                        </td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd;"><strong>${item.descripcion}</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: center;">${item.unidad}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; text-align: right; font-family: monospace;">$${formatNumber(item.precio_tarifa)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Llenar cada secci贸n
            document.getElementById('materiales-content').innerHTML = createMaterialesTable(materialesConsolidados);
            document.getElementById('equipos-content').innerHTML = createEquiposTable(equiposConsolidados);
            document.getElementById('transporte-content').innerHTML = createTransportesTable(transportesConsolidados);
            document.getElementById('manoobra-content').innerHTML = createManoObraTable(manoObraConsolidada);
            document.getElementById('otros-content').innerHTML = createOtrosTable(matricesConsolidadas, trabajosConsolidados);
            
            // Actualizar badges con contadores
            document.getElementById('materiales-badge').textContent = materialesConsolidados.length;
            document.getElementById('equipos-badge').textContent = equiposConsolidados.length;
            document.getElementById('transporte-badge').textContent = transportesConsolidados.length;
            document.getElementById('manoobra-badge').textContent = manoObraConsolidada.length;
            document.getElementById('otros-badge').textContent = matricesConsolidadas.length + trabajosConsolidados.length;
            
            consolidatedModalOverlay.classList.add('active');
        }

        // Funci贸n para exportar listas consolidadas
        function exportConsolidatedLists() {
            if (selectedAPUs.size === 0) return;
            
            const selectedData = Array.from(selectedAPUs).map(id => {
                const apu = allAPUs.find(a => a.id === id);
                return apu ? { codigo: apu.item, data: apu.rawData } : null;
            }).filter(Boolean);
            
            // Funci贸n para consolidar elementos
            function consolidateElements(category) {
                const consolidated = {};
                
                selectedData.forEach(({ codigo, data }) => {
                    const elements = data[category] || [];
                    elements.forEach(item => {
                        if (!item.descripcion || item.descripcion === 'ITEM') return;
                        
                        const key = `${item.descripcion}_${item.unidad}_${item.precio_tarifa}`;
                        
                        if (!consolidated[key]) {
                            consolidated[key] = {
                                descripcion: item.descripcion,
                                unidad: item.unidad || 'N/A',
                                cantidad: 0,
                                precio_tarifa: item.precio_tarifa || 0,
                                valor_total: 0,
                                apus: new Set(),
                                precio_unitario_promedio: item.precio_tarifa || 0
                            };
                        }
                        
                        consolidated[key].cantidad += (item.cantidad || 0);
                        consolidated[key].valor_total += (item.valor_unitario || 0);
                        consolidated[key].apus.add(codigo);
                    });
                });
                
                // Convertir a array y calcular valores
                return Object.values(consolidated).map(item => ({
                    ...item,
                    apus: Array.from(item.apus).sort().join(', '),
                    frecuencia: item.apus.size
                })).sort((a, b) => a.descripcion.localeCompare(b.descripcion));
            }
            
            // Crear workbook
            const wb = XLSX.utils.book_new();
            
            // Categor铆as a procesar
            const categories = [
                { name: 'materiales', title: 'MATERIALES' },
                { name: 'equipos', title: 'EQUIPOS' },
                { name: 'mano_obra', title: 'MANO DE OBRA' },
                { name: 'transporte', title: 'TRANSPORTES' },
                { name: 'matrices', title: 'MATRICES' },
                { name: 'trabajos', title: 'TRABAJOS' }
            ];
            
            let resumenData = [];
            
            categories.forEach(({ name, title }) => {
                const consolidated = consolidateElements(name);
                
                if (consolidated.length > 0) {
                    // Crear hoja para esta categor铆a
                    const sheetData = [];
                    
                    // Header
                    sheetData.push([title, '', '', '', '', '', '']);
                    sheetData.push(['', '', '', '', '', '', '']);
                    sheetData.push(['Descripci贸n', 'Unidad', 'Cantidad Total', 'Precio Unit.', 'Valor Total', 'APUs que lo usan', 'Frecuencia']);
                    
                    let totalValor = 0;
                    consolidated.forEach(item => {
                        totalValor += item.valor_total;
                        sheetData.push([
                            item.descripcion,
                            item.unidad,
                            formatNumber(item.cantidad),
                            `$${formatNumber(item.precio_unitario_promedio)}`,
                            `$${formatNumber(item.valor_total)}`,
                            item.apus,
                            item.frecuencia
                        ]);
                    });
                    
                    // Total
                    sheetData.push(['', '', '', 'TOTAL:', `$${formatNumber(totalValor)}`, '', '']);
                    
                    // Crear worksheet
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    
                    // Desactivar l铆neas de cuadr铆cula
                    if (!ws['!views']) ws['!views'] = [{}];
                    ws['!views'][0] = { showGridLines: false };
                    
                    // Aplicar estilos
                    const headerStyle = {
                        font: { bold: true, sz: 12 },
                        fill: { fgColor: { rgb: "D9D9D9" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    
                    const titleStyle = {
                        font: { bold: true, sz: 14 },
                        fill: { fgColor: { rgb: "4F81BD" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    
                    // Aplicar estilos a header principal
                    ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1'].forEach(cell => {
                        if (!ws[cell]) ws[cell] = { v: "" };
                        ws[cell].s = titleStyle;
                    });
                    
                    // Aplicar estilos a header de tabla
                    ['A3', 'B3', 'C3', 'D3', 'E3', 'F3', 'G3'].forEach(cell => {
                        if (!ws[cell]) ws[cell] = { v: "" };
                        ws[cell].s = headerStyle;
                    });
                    
                    // Combinar t铆tulo
                    ws['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }
                    ];
                    
                    // Configurar anchos
                    ws['!cols'] = [
                        {wch: 45}, {wch: 12}, {wch: 15}, {wch: 15}, 
                        {wch: 15}, {wch: 25}, {wch: 12}
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, title);
                    
                    // Agregar al resumen
                    resumenData.push({
                        categoria: title,
                        elementos: consolidated.length,
                        valor_total: totalValor
                    });
                }
            });
            
            // Crear hoja de resumen
            if (resumenData.length > 0) {
                const resumenSheet = [];
                resumenSheet.push(['RESUMEN CONSOLIDADO', '', '', '']);
                resumenSheet.push(['', '', '', '']);
                resumenSheet.push(['Categor铆a', 'Elementos', 'Valor Total', 'Porcentaje']);
                
                const totalGeneral = resumenData.reduce((sum, item) => sum + item.valor_total, 0);
                
                resumenData.forEach(item => {
                    const porcentaje = totalGeneral > 0 ? (item.valor_total / totalGeneral * 100).toFixed(2) : 0;
                    resumenSheet.push([
                        item.categoria,
                        item.elementos,
                        `$${formatNumber(item.valor_total)}`,
                        `${porcentaje}%`
                    ]);
                });
                
                resumenSheet.push(['TOTAL GENERAL', '', `$${formatNumber(totalGeneral)}`, '100%']);
                
                const wsResumen = XLSX.utils.aoa_to_sheet(resumenSheet);
                
                // Estilos para resumen
                if (!wsResumen['!views']) wsResumen['!views'] = [{}];
                wsResumen['!views'][0] = { showGridLines: false };
                
                wsResumen['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }
                ];
                
                wsResumen['!cols'] = [{wch: 20}, {wch: 15}, {wch: 20}, {wch: 15}];
                
                XLSX.utils.book_append_sheet(wb, wsResumen, 'RESUMEN');
            }
            
            // Descargar
            XLSX.writeFile(wb, `Listas_Consolidadas_${new Date().toISOString().split('T')[0]}.xlsx`);
        }


        // Funciones de navegaci贸n
        function showPresentacion() {
            hideAllSections();
            document.getElementById('presentacion-section').classList.add('active');
            updateActiveNav('presentacion');
        }

        function showMarcoMetodologico() {
            hideAllSections();
            document.getElementById('marco-metodologico-section').classList.add('active');
            updateActiveNav('marco-metodologico');
        }

        function showAPUs() {
            hideAllSections();
            document.getElementById('apus-section').classList.add('active');
            updateActiveNav('apus');
        }

        function hideAllSections() {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
        }

        function updateActiveNav(activeSection) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`a[href="#${activeSection}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }



        // ===== INITIALIZE ON LOAD =====
        document.addEventListener('DOMContentLoaded', loadJSONData);
    </script>




</body>
</html>
